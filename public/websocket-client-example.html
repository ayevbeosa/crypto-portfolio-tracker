<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Price WebSocket Demo</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .prices {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .price-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        transition: transform 0.2s;
      }
      .price-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .symbol {
        font-size: 20px;
        font-weight: bold;
        color: #007bff;
      }
      .price {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
      }
      .change {
        font-size: 14px;
      }
      .change.positive {
        color: #28a745;
      }
      .change.negative {
        color: #dc3545;
      }
      .logs {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        padding-left: 10px;
      }
      input {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        width: 200px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸš€ Real-Time Crypto Prices</h1>

      <div id="status" class="status disconnected">Disconnected</div>

      <div class="controls">
        <button class="btn-primary" onclick="connect()">Connect</button>
        <button class="btn-danger" onclick="disconnect()">Disconnect</button>
        <input
          type="text"
          id="symbols"
          placeholder="BTC,ETH,SOL"
          value="BTC,ETH,SOL"
        />
        <button class="btn-success" onclick="subscribe()">Subscribe</button>
        <button class="btn-danger" onclick="unsubscribe()">Unsubscribe</button>
      </div>

      <h2>Live Prices</h2>
      <div id="prices" class="prices"></div>

      <h2>Event Log</h2>
      <div id="logs" class="logs"></div>
    </div>

    <script>
      let socket;
      const prices = {};

      function log(message, data = null) {
        const logsDiv = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (data) {
          entry.textContent += ` ${JSON.stringify(data)}`;
        }
        logsDiv.insertBefore(entry, logsDiv.firstChild);
      }

      function updateStatus(connected) {
        const statusDiv = document.getElementById('status');
        statusDiv.className = connected
          ? 'status connected'
          : 'status disconnected';
        statusDiv.textContent = connected ? 'âœ“ Connected' : 'âœ— Disconnected';
      }

      function updatePrice(symbol, price, change24h) {
        prices[symbol] = { price, change24h };
        renderPrices();
      }

      function renderPrices() {
        const pricesDiv = document.getElementById('prices');
        pricesDiv.innerHTML = '';

        Object.entries(prices).forEach(([symbol, data]) => {
          const card = document.createElement('div');
          card.className = 'price-card';

          const changeClass = data.change24h >= 0 ? 'positive' : 'negative';
          const changeSign = data.change24h >= 0 ? '+' : '';

          card.innerHTML = `
                    <div class="symbol">${symbol}</div>
                    <div class="price">$${data.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="change ${changeClass}">${changeSign}${data.change24h.toFixed(2)}%</div>
                `;

          pricesDiv.appendChild(card);
        });
      }

      function connect() {
        if (socket && socket.connected) {
          log('Already connected');
          return;
        }

        // Connect to WebSocket
        socket = io('http://localhost:3000/prices', {
          transports: ['websocket'],
          // Optional: Add auth token
          // auth: {
          //     token: 'your-jwt-token-here'
          // }
        });

        // Connection events
        socket.on('connect', () => {
          log('Connected to WebSocket server');
          updateStatus(true);
        });

        socket.on('disconnect', () => {
          log('Disconnected from server');
          updateStatus(false);
        });

        socket.on('connected', (data) => {
          log('Connection confirmed', data);
        });

        // Price updates
        socket.on('price-update', (data) => {
          log(`Price update: ${data.symbol}`);
          updatePrice(data.symbol, data.price, data.change24h);
        });

        // Subscription events
        socket.on('subscribed', (data) => {
          log('Subscribed to symbols', data.symbols);
          // Update prices with current values
          Object.entries(data.currentPrices).forEach(([symbol, priceData]) => {
            updatePrice(symbol, priceData.price, priceData.change24h);
          });
        });

        socket.on('unsubscribed', (data) => {
          log('Unsubscribed from symbols', data.symbols);
          // Remove prices
          data.symbols.forEach((symbol) => delete prices[symbol]);
          renderPrices();
        });

        // Other events
        socket.on('stats', (data) => {
          log('Connection stats', data);
        });

        socket.on('announcement', (data) => {
          log(`ANNOUNCEMENT [${data.type}]: ${data.message}`);
        });

        socket.on('error', (data) => {
          log('ERROR: ' + data.message);
        });

        socket.on('pong', (data) => {
          log('Pong received', data);
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          updateStatus(false);
          log('Disconnected');
        }
      }

      function subscribe() {
        if (!socket || !socket.connected) {
          log('Not connected');
          return;
        }

        const symbolsInput = document.getElementById('symbols').value;
        const symbols = symbolsInput
          .split(',')
          .map((s) => s.trim())
          .filter((s) => s);

        if (symbols.length === 0) {
          log('No symbols provided');
          return;
        }

        socket.emit('subscribe', { symbols });
        log('Subscribing to: ' + symbols.join(', '));
      }

      function unsubscribe() {
        if (!socket || !socket.connected) {
          log('Not connected');
          return;
        }

        const symbolsInput = document.getElementById('symbols').value;
        const symbols = symbolsInput
          .split(',')
          .map((s) => s.trim())
          .filter((s) => s);

        if (symbols.length === 0) {
          log('No symbols provided');
          return;
        }

        socket.emit('unsubscribe', { symbols });
        log('Unsubscribing from: ' + symbols.join(', '));
      }

      // Auto-connect on page load
      window.onload = () => {
        connect();
        setTimeout(subscribe, 1000);
      };
    </script>
  </body>
</html>
